# Nav2 ナビゲーションコンセプト要約

## 概要
このドキュメントは、Nav2（Navigation 2）プロジェクトで使用される主要なコンセプトと技術について説明します。モバイルロボットナビゲーションの基本概念から、ROS 2固有の実装まで幅広くカバーしています。

## ROS 2 基礎概念

### アクションサーバー
- 長時間実行されるタスク（ナビゲーションなど）を制御するための仕組み
- クライアントがタスクを要求し、サーバーがフィードバックと結果を提供
- Nav2では`NavigateToPose`アクションメッセージを通じてBehavior Treeナビゲーターと通信

### ライフサイクルノードとボンド
- ROS 2固有の状態機械遷移を持つノード
- 起動・終了時の決定論的動作を保証
- 状態：未設定 → 非アクティブ → アクティブ → 非アクティブ → クリーンアップ → 終了
- Nav2では`nav2_util LifecycleNode`ラッパーを使用
- ボンド接続により、サーバークラッシュ時にライフサイクルマネージャーに通知

## Behavior Trees（行動木）

### 基本概念
- 複雑なロボティクスタスクで使用される木構造
- 有限状態機械（FSM）よりもスケーラブルで理解しやすい
- 基本的なプリミティブ（「蹴る」「歩く」「ボールに向かう」など）を再利用可能

### Nav2での実装
- [BehaviorTree CPP V4](https://www.behaviortree.dev/)ライブラリを使用
- `BT Navigator`内でノードプラグインを構築
- XMLファイルから木構造を解析
- サブツリーの読み込みが可能

## ナビゲーションサーバー

### 主要サーバー
1. **プランナーサーバー**: パス計画を計算
2. **コントローラーサーバー**: パス追従制御
3. **スムーザーサーバー**: パスの品質改善
4. **ルートサーバー**: ナビゲーショングラフを使用したルート計算
5. **ビヘイビアサーバー**: 回復行動とその他の行動

### プランナー
- 目標達成のためのパス計算
- 種類：
  - 最短パス計算
  - 完全カバレッジパス
  - 事前定義ルートに沿ったパス

### コントローラー
- グローバルパスの追従またはローカルタスクの完了
- 種類：
  - パス追従
  - 充電ステーションとのドッキング
  - エレベーター乗車
  - ツールとのインターフェース

### ビヘイビア（回復行動）
- 障害耐性システムの主要要素
- 例：
  - コストマップクリア
  - 後退・回転動作
  - オペレーター通知（メール、SMS、Slackなど）

### スムーザー
- プランナーが計算したパスの品質改善
- パスの粗さ軽減、急激な回転の平滑化
- 障害物からの距離増加

### ルート
- ナビゲーショングラフを使用した特殊なプランナー
- レーン、許可エリア、教示・再生ルート、都市道路などを表現

### ロボットフットプリント
- 円形（`robot_radius`）または任意の多角形（`footprint`）
- `~/footprint`トピックで動的更新可能

### ウェイポイント追従
- `nav2_waypoint_follower`パッケージ
- 複数の目的地への移動
- タスクエグゼキューターのプラグインインターフェース
- GPSウェイポイント追従もサポート

## 状態推定

### 標準
- [REP 105](https://www.ros.org/reps/rep-0105.html)に従った座標系
- 必須のTF木：`map` → `odom` → `base_link` → `[sensor frames]`

### グローバル位置推定：ローカライゼーションとSLAM
- `map` → `odom`変換を提供
- AMCL（適応モンテカルロローカライゼーション）
- SLAM Toolbox（デフォルトSLAMアルゴリズム）

### オドメトリ
- `odom` → `base_link`変換を提供
- 情報源：LIDAR、RADAR、ホイールエンコーダー、VIO、IMU
- Robot Localizationによる複数センサーの融合

## 環境表現

### コストマップとレイヤー
- 2D格子状のセル（未知、自由、占有、膨張コスト）
- プラグインライブラリによる各種レイヤー実装
- センサーデータ（LIDAR、RADAR、ソナー、深度画像など）をバッファリング

### コストマップフィルター
- 空間依存の行動変化を適用
- フィルターマスクによる注釈付きマップ
- 用途例：
  - 立入禁止ゾーン
  - 速度制限エリア
  - 優先レーン

### その他の形式
- グラディエントマップ（表面勾配）
- 3Dコストマップ
- メッシュマップ
- ベクター空間（機械学習による個別アイテム検出）

## 重要な注意事項
- LIDARの使用は必須ではない
- 視覚や深度ベースの位置推定システムも使用可能
- REP-105標準に従うことが唯一の要件

## まとめ
Nav2は、ROS 2の強力な機能を活用して、スケーラブルで柔軟なナビゲーションシステムを提供します。Behavior Treesによる論理構造、プラグインベースのアーキテクチャ、標準化された座標系により、様々なロボットプラットフォームで使用可能な汎用的なナビゲーションソリューションを実現しています。
